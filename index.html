<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Conference Countdown</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    :root{
      --bg-normal:#000000;
      --bg-t1:#7a6b00;
      --bg-t2:#8a1c1c;
      --digits:#00ff8a;
    }
    html,body{height:100%;margin:0;background:var(--bg-normal);font-family:-apple-system,BlinkMacSystemFont,Inter,Roboto,Segoe UI,system-ui}
    .wrap{height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:28px}
    .time{color:var(--digits);font-weight:800;font-size:18vw;line-height:1;letter-spacing:.02em;user-select:none}
    .bar{position:fixed;left:0;bottom:0;height:12px;background:var(--digits);transition:width .2s}
    .controls{position:fixed;top:0;left:0;right:0;background:#111a;backdrop-filter:blur(6px);display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:center;padding:10px}
    .controls fieldset{border:1px solid #333;border-radius:12px;padding:8px 10px;color:#eee}
    .controls legend{font-size:12px;color:#aaa;padding:0 6px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    label{color:#ddd;font-size:14px;display:flex;gap:6px;align-items:center}
    input[type="number"]{width:64px;padding:6px 8px;border-radius:10px;border:1px solid #333;background:#000;color:#fff}
    input[type="color"]{width:40px;height:28px;border:none;background:none;padding:0}
    button{font-size:16px;padding:10px 16px;border-radius:14px;border:0}
    button.primary{background:#2b8a3e;color:#fff}
    button.gray{background:#222;color:#ddd}
    .spacer{flex:0 0 100%}
    .main-buttons{display:flex;gap:10px}
  </style>
</head>
<body>
  <div class="controls" id="panel">
    <div class="main-buttons">
      <button class="primary" id="btnToggle">Start</button>
      <button class="gray" id="btnReset">Reset</button>
      <label><input type="checkbox" id="chkLoop" checked> Auto-loop</label>
      <label><input type="checkbox" id="chkSound" checked> Sound on finish</label>
    </div>

    <span class="spacer"></span>

    <fieldset>
      <legend>Duration</legend>
      <div class="row">
        <label>Min <input type="number" id="durMin" min="0" value="15"></label>
        <label>Sec <input type="number" id="durSec" min="0" max="59" value="0"></label>
      </div>
    </fieldset>

    <fieldset>
      <legend>Color change at</legend>
      <div class="row">
        <label>t1 — Min <input type="number" id="t1Min" min="0" value="1"></label>
        <label>Sec <input type="number" id="t1Sec" min="0" max="59" value="0"></label>
      </div>
      <div class="row">
        <label>t2 — Min <input type="number" id="t2Min" min="0" value="0"></label>
        <label>Sec <input type="number" id="t2Sec" min="0" max="59" value="10"></label>
      </div>
    </fieldset>

    <fieldset>
      <legend>Colors</legend>
      <div class="row">
        <label>Background (Normal) <input type="color" id="cBgNormal" value="#000000"></label>
        <label>Background (≤ t1) <input type="color" id="cBgT1" value="#7a6b00"></label>
        <label>Background (≤ t2) <input type="color" id="cBgT2" value="#8a1c1c"></label>
      </div>
      <div class="row">
        <label>Digits <input type="color" id="cDigits" value="#00ff8a"></label>
      </div>
    </fieldset>
  </div>

  <div class="wrap" id="root">
    <div class="time" id="clock">15:00</div>
    <div class="bar" id="bar" style="width:100%"></div>
  </div>

<script>
/* ---------- Utilities ---------- */
const $ = s => document.querySelector(s);
const els = {
  clock: $('#clock'), bar: $('#bar'), root: $('#root'),
  btnToggle: $('#btnToggle'), btnReset: $('#btnReset'),
  chkLoop: $('#chkLoop'), chkSound: $('#chkSound'),
  durMin: $('#durMin'), durSec: $('#durSec'),
  t1Min: $('#t1Min'), t1Sec: $('#t1Sec'),
  t2Min: $('#t2Min'), t2Sec: $('#t2Sec'),
  cBgNormal: $('#cBgNormal'), cBgT1: $('#cBgT1'), cBgT2: $('#cBgT2'),
  cDigits: $('#cDigits')
};

function clampInt(v, lo, hi){ v = Math.floor(Number(v)||0); if (lo!=null) v = Math.max(lo,v); if (hi!=null) v = Math.min(hi,v); return v; }
function toSec(min,sec){ return clampInt(min,0,1e9)*60 + clampInt(sec,0,59); }
function fmt(s){ const m=Math.floor(s/60), t=s%60; return `${String(m).padStart(2,'0')}:${String(t).padStart(2,'0')}`; }

/* ---------- State ---------- */
let total = 15*60, remain = total, running = false, last = performance.now();
let t1 = 60, t2 = 10;
let audioCtx = null;

/* ---------- Persist / Restore ---------- */
const LS_KEY = 'conf_timer_v2';
function save(){
  const data = {
    loop: els.chkLoop.checked,
    sound: els.chkSound.checked,
    durMin: els.durMin.value, durSec: els.durSec.value,
    t1Min: els.t1Min.value, t1Sec: els.t1Sec.value,
    t2Min: els.t2Min.value, t2Sec: els.t2Sec.value,
    cBgNormal: els.cBgNormal.value,
    cBgT1: els.cBgT1.value,
    cBgT2: els.cBgT2.value,
    cDigits: els.cDigits.value
  };
  localStorage.setItem(LS_KEY, JSON.stringify(data));
}
function restore(){
  const raw = localStorage.getItem(LS_KEY);
  if(!raw) return;
  try{
    const d = JSON.parse(raw);
    els.chkLoop.checked = !!d.loop;
    els.chkSound.checked = !!d.sound;
    for (const k of ['durMin','durSec','t1Min','t1Sec','t2Min','t2Sec']) if (d[k]!=null) els[k].value = d[k];
    for (const k of ['cBgNormal','cBgT1','cBgT2','cDigits']) if (d[k]) els[k].value = d[k];
  }catch{}
}

/* ---------- Audio ---------- */
function beep(){
  if(!els.chkSound.checked) return;
  try{
    audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
    const o = audioCtx.createOscillator(), g = audioCtx.createGain();
    o.type='sine'; o.frequency.value = 880; g.gain.value = 0.001;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    g.gain.exponentialRampToValueAtTime(0.4, audioCtx.currentTime + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.4);
    o.stop(audioCtx.currentTime + 0.45);
    if (navigator.vibrate) navigator.vibrate(200);
  }catch{}
}

/* ---------- Render ---------- */
function applyColors(){
  document.documentElement.style.setProperty('--bg-normal', els.cBgNormal.value);
  document.documentElement.style.setProperty('--bg-t1', els.cBgT1.value);
  document.documentElement.style.setProperty('--bg-t2', els.cBgT2.value);
  document.documentElement.style.setProperty('--digits', els.cDigits.value);
}
function applyThresholdBg(){
  let bg = getComputedStyle(document.documentElement).getPropertyValue('--bg-normal');
  if (remain <= t1) bg = getComputedStyle(document.documentElement).getPropertyValue('--bg-t1');
  if (remain <= t2) bg = getComputedStyle(document.documentElement).getPropertyValue('--bg-t2');
  document.body.style.background = bg.trim();
}
function render(){
  els.clock.textContent = fmt(remain);
  els.bar.style.width = `${Math.max(0, remain/total)*100}%`;
  applyThresholdBg();
}

/* ---------- Controls ---------- */
function recomputeFromInputs({resetTimer=false}={}){
  // duration
  total = Math.max(1, toSec(els.durMin.value, els.durSec.value));
  // thresholds
  t1 = toSec(els.t1Min.value, els.t1Sec.value);
  t2 = toSec(els.t2Min.value, els.t2Sec.value);
  // enforce t2 <= t1
  if (t2 > t1){ const tmp=t2; t2=t1; t1=tmp;  // swap so smaller becomes t2
    // reflect swap into inputs for clarity
    const [a1,a2,b1,b2] = [els.t1Min.value, els.t1Sec.value, els.t2Min.value, els.t2Sec.value];
    els.t1Min.value = b1; els.t1Sec.value = b2;
    els.t2Min.value = a1; els.t2Sec.value = a2;
  }
  applyColors();
  if (resetTimer){ remain = Math.min(remain, total); if (!running) remain = total; }
  render(); save();
}

function start(){
  if(!running){
    running = true;
    last = performance.now();
    els.btnToggle.textContent = 'Pause';
    tick();
  }
}
function pause(){
  running = false;
  els.btnToggle.textContent = 'Start';
}
function reset(){
  pause();
  remain = total;
  render();
}

function tick(){
  if(!running) return;
  const now = performance.now();
  const dt = (now - last)/1000;
  last = now;

  if (dt >= 1){
    remain = Math.max(0, remain - Math.floor(dt));
    render();
    if (remain === 0){
      beep();
      if (els.chkLoop.checked){
        remain = total;
        render();
      } else {
        pause();
      }
    }
  }
  requestAnimationFrame(tick);
}

/* ---------- Events ---------- */
els.btnToggle.onclick = () => running ? pause() : start();
els.btnReset.onclick  = reset;

// Any input change -> recompute & persist
for (const el of [els.chkLoop, els.chkSound,
                  els.durMin, els.durSec,
                  els.t1Min, els.t1Sec, els.t2Min, els.t2Sec,
                  els.cBgNormal, els.cBgT1, els.cBgT2, els.cDigits]){
  el.addEventListener('input', () => recomputeFromInputs({resetTimer:true}));
}

// Tapping the big digits toggles start/pause
els.clock.onclick = () => running ? pause() : start();

// Prevent double-tap zoom
let lastTap = 0;
window.addEventListener('touchend', e=>{
  const now = Date.now();
  if (now - lastTap < 350) e.preventDefault();
  lastTap = now;
},{passive:false});

/* ---------- Init ---------- */
restore();
recomputeFromInputs({resetTimer:true});
render();
</script>
</body>
</html>
